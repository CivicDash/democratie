# üíæ Documentation Cache Redis - CivicDash

## üìñ Vue d'ensemble

CivicDash utilise **Redis** comme syst√®me de cache pour optimiser les performances et r√©duire la charge sur la base de donn√©es PostgreSQL.

### Pourquoi le cache ?

- ‚ö° **Performance** : R√©ponses 10-100x plus rapides
- üí∞ **√âconomie** : Moins de requ√™tes SQL co√ªteuses
- üîí **S√©curit√©** : Limite les requ√™tes sur donn√©es sensibles (votes)
- üìà **Scalabilit√©** : Support de milliers d'utilisateurs simultan√©s

## üèóÔ∏è Architecture

```
User Request
     ‚Üì
Controller
     ‚Üì
Service ‚Üí CacheService ‚îÄ‚îÄ‚Üí Redis (cache hit ‚úì)
     ‚Üì                           ‚Üë
   Database ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   (si cache miss)          (mise en cache)
```

## üé® CacheService

Service centralis√© pour g√©rer tout le cache de l'application.

**Fichier** : `app/Services/CacheService.php`

### Dur√©es de cache

```php
const CACHE_FOREVER = 0;        // Permanent
const CACHE_1_HOUR = 3600;      // 1 heure
const CACHE_4_HOURS = 14400;    // 4 heures
const CACHE_1_DAY = 86400;      // 1 jour
const CACHE_1_WEEK = 604800;    // 1 semaine
```

### Pr√©fixes de cl√©s

```php
const PREFIX_VOTE_RESULTS = 'vote:results:';
const PREFIX_BUDGET_STATS = 'budget:stats';
const PREFIX_BUDGET_AVERAGES = 'budget:averages';
const PREFIX_BUDGET_RANKING = 'budget:ranking';
const PREFIX_MODERATION_STATS = 'moderation:stats';
const PREFIX_DOCUMENT_STATS = 'documents:stats';
const PREFIX_TOPIC_STATS = 'topic:stats:';
const PREFIX_USER_ALLOCATIONS = 'user:allocations:';
```

## üó≥Ô∏è Cache des R√©sultats de Vote

### Pourquoi cacher les r√©sultats ?

- D√©chiffrement des votes co√ªteux (cryptographie)
- R√©sultats consult√©s fr√©quemment
- Calculs lourds (agr√©gation, pourcentages)

### Impl√©mentation

```php
// Dans BallotService.php
public function calculateResults(Topic $topic): array
{
    // V√©rifier le cache d'abord
    $cached = $this->cacheService->getVoteResults($topic->id);
    if ($cached !== null) {
        return $cached;  // Cache hit ‚úì
    }

    // Calculer les r√©sultats (co√ªteux)
    $results = $this->performExpensiveCalculation($topic);

    // Mettre en cache pour 1 heure
    $this->cacheService->cacheVoteResults($topic->id, $results);

    return $results;
}
```

### Invalidation

Le cache est invalid√© automatiquement quand un nouveau vote est √©mis :

```php
public function castVote(string $token, array $vote): TopicBallot
{
    // ... voter ...

    // Invalider le cache pour recalculer les r√©sultats
    $this->cacheService->invalidateVoteResults($topic->id);

    return $ballot;
}
```

**Dur√©e** : 1 heure (actualisation automatique)

## üí∞ Cache du Budget Participatif

### Donn√©es cach√©es

1. **Statistiques globales** (4 heures)
   - Nombre de participants
   - Date derni√®re mise √† jour
   - Total des allocations

2. **Allocations moyennes** (4 heures)
   - Moyenne par secteur
   - Utilis√© pour comparaisons

3. **Classement des secteurs** (4 heures)
   - Secteurs prioritaires
   - Classement avec podium

4. **Allocations utilisateur** (1 jour)
   - Allocations personnelles
   - Cache par utilisateur

### Exemple d'utilisation

```php
// BudgetService.php
public function getAverageAllocations(): array
{
    // V√©rifier le cache
    $cached = $this->cacheService->getBudgetAverages();
    if ($cached !== null) {
        return $cached;
    }

    // Calculer (requ√™te SQL complexe)
    $averages = $this->calculateAverages();

    // Mettre en cache
    $this->cacheService->cacheBudgetAverages($averages);

    return $averages;
}
```

### Invalidation

Invalidation automatique quand un utilisateur change son allocation :

```php
public function bulkAllocate(User $user, array $allocations): void
{
    // ... sauvegarder ...

    // Invalider tout le cache budget
    $this->cacheService->invalidateBudgetCache();
}
```

## üö® Cache de Mod√©ration

### Donn√©es cach√©es

- **Statistiques mod√©ration** (1 heure)
  - Signalements en attente
  - En investigation
  - R√©solus aujourd'hui
  - Mod√©rateurs actifs

### Pourquoi 1 heure ?

- Donn√©es sensibles qui changent fr√©quemment
- Besoin de voir les nouveaux signalements rapidement
- Balance entre performance et actualit√©

## üìÑ Cache des Documents

### Donn√©es cach√©es

- **Statistiques documents** (4 heures)
  - Total documents
  - Documents v√©rifi√©s
  - En attente de v√©rification
  - Nombre de v√©rificateurs

## üìù Cache des Topics

### Donn√©es cach√©es

- **Statistiques par topic** (1 heure)
  - Nombre de posts
  - Nombre de votes
  - Activit√© r√©cente

## üîß M√©thodes du CacheService

### M√©thodes g√©n√©rales

```php
// Obtenir ou calculer
$value = $cacheService->remember($key, $ttl, function() {
    return $this->expensiveCalculation();
});

// Obtenir
$value = $cacheService->get($key, $default);

// Stocker
$cacheService->put($key, $value, $ttl);

// Supprimer
$cacheService->forget($key);

// Supprimer par pattern
$count = $cacheService->forgetPattern('vote:*');

// V√©rifier existence
if ($cacheService->has($key)) { ... }

// Incr√©menter/D√©cr√©menter
$cacheService->increment('counter');
$cacheService->decrement('counter');
```

### M√©thodes sp√©cifiques Vote

```php
// Cache
$cacheService->cacheVoteResults($topicId, $results);

// R√©cup√©rer
$results = $cacheService->getVoteResults($topicId);

// Invalider
$cacheService->invalidateVoteResults($topicId);
```

### M√©thodes sp√©cifiques Budget

```php
// Cache stats
$cacheService->cacheBudgetStats($stats);
$cacheService->cacheBudgetAverages($averages);
$cacheService->cacheBudgetRanking($ranking);

// R√©cup√©rer
$stats = $cacheService->getBudgetStats();
$averages = $cacheService->getBudgetAverages();
$ranking = $cacheService->getBudgetRanking();

// Invalider tout
$count = $cacheService->invalidateBudgetCache();
```

### M√©thodes sp√©cifiques User

```php
// Cache allocations utilisateur
$cacheService->cacheUserAllocations($userId, $allocations);

// R√©cup√©rer
$allocations = $cacheService->getUserAllocations($userId);

// Invalider
$cacheService->invalidateUserAllocations($userId);
```

## üéÆ Commandes Artisan

### Vider le cache de vote

```bash
# Vider tout le cache de vote
php artisan cache:clear-vote

# Vider le cache d'un topic sp√©cifique
php artisan cache:clear-vote 42
```

### Vider le cache budget

```bash
php artisan cache:clear-budget
```

**Vide** :
- Stats budget
- Allocations moyennes
- Ranking des secteurs
- Allocations utilisateurs

### Vider TOUT le cache CivicDash

```bash
# Avec confirmation
php artisan cache:clear-civicdash

# Sans confirmation (scripts automatis√©s)
php artisan cache:clear-civicdash --force
```

**Vide** :
- ‚úì Vote
- ‚úì Budget
- ‚úì Mod√©ration
- ‚úì Documents
- ‚úì Topics

## üìä Exemple Complet : Workflow de Vote

### 1. Utilisateur demande les r√©sultats

```
GET /api/topics/1/vote/results
     ‚Üì
VoteController@results
     ‚Üì
BallotService->calculateResults($topic)
     ‚Üì
CacheService->getVoteResults(1)  ‚Üê Cache hit ‚úì (si existe)
     ‚Üì
[Retour imm√©diat des r√©sultats cach√©s]
```

### 2. Cache miss : Calcul des r√©sultats

```
BallotService->calculateResults($topic)
     ‚Üì
CacheService->getVoteResults(1)  ‚Üê Cache miss ‚úó
     ‚Üì
[D√©chiffrement de tous les votes]
[Agr√©gation des r√©sultats]
[Calcul des pourcentages]
     ‚Üì
CacheService->cacheVoteResults(1, $results)  ‚Üê Mise en cache
     ‚Üì
[Retour des r√©sultats + cache pour 1h]
```

### 3. Nouveau vote √©mis

```
POST /api/topics/1/vote/cast
     ‚Üì
BallotService->castVote($token, $vote)
     ‚Üì
[Cr√©ation du ballot anonyme]
     ‚Üì
CacheService->invalidateVoteResults(1)  ‚Üê Invalidation
     ‚Üì
[Prochain appel recalculera les r√©sultats]
```

## üî• Performance

### Avant le cache

```
GET /api/topics/1/vote/results
- D√©chiffrement de 1000 votes : 2500ms
- Agr√©gation SQL : 150ms
- Calcul pourcentages : 50ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL : ~2700ms (2.7 secondes) ‚ùå
```

### Apr√®s le cache

```
GET /api/topics/1/vote/results
- Redis GET : 5ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL : ~5ms (0.005 seconde) ‚úÖ

Am√©lioration : 540x plus rapide ! üöÄ
```

## üõ†Ô∏è Configuration

### .env

```env
# Cache driver (Redis)
CACHE_DRIVER=redis

# Redis configuration
REDIS_HOST=redis
REDIS_PASSWORD=null
REDIS_PORT=6379
REDIS_CACHE_DB=1  # Base d√©di√©e au cache
```

### config/cache.php

```php
'redis' => [
    'driver' => 'redis',
    'connection' => env('REDIS_CACHE_CONNECTION', 'cache'),
    'lock_connection' => env('REDIS_CACHE_LOCK_CONNECTION', 'default'),
],
```

### config/database.php

```php
'redis' => [
    'cache' => [
        'url' => env('REDIS_URL'),
        'host' => env('REDIS_HOST', '127.0.0.1'),
        'username' => env('REDIS_USERNAME'),
        'password' => env('REDIS_PASSWORD'),
        'port' => env('REDIS_PORT', '6379'),
        'database' => env('REDIS_CACHE_DB', '1'),
    ],
],
```

## üîç Monitoring

### V√©rifier les cl√©s en cache

```bash
# Se connecter √† Redis
docker exec -it demoscratos-redis-1 redis-cli

# Lister les cl√©s de vote
KEYS "*vote:results:*"

# Voir une cl√© sp√©cifique
GET "laravel_cache:vote:results:1"

# Voir TTL (temps restant)
TTL "laravel_cache:vote:results:1"

# Nombre total de cl√©s
DBSIZE

# Vider toute la base (ATTENTION)
FLUSHDB
```

### Stats Redis

```bash
# Informations Redis
INFO stats

# Taux de cache hit
INFO stats | grep hits
INFO stats | grep misses
```

## üìà Strat√©gie de Cache

### Quand cacher ?

‚úÖ **√Ä cacher** :
- R√©sultats de vote (d√©chiffrement co√ªteux)
- Stats aggreg√©es (calculs complexes)
- Donn√©es consult√©es fr√©quemment
- R√©sultats de requ√™tes lentes (> 100ms)

‚ùå **√Ä ne PAS cacher** :
- Donn√©es en temps r√©el critiques
- Donn√©es personnelles sensibles
- Flux d'activit√© en direct
- Donn√©es changeant constamment

### Dur√©es recommand√©es

| Donn√©e | Dur√©e | Raison |
|--------|-------|--------|
| R√©sultats vote | 1h | Balance actualit√©/performance |
| Stats budget | 4h | Change rarement |
| Allocations user | 1 jour | Donn√©es personnelles stables |
| Stats mod√©ration | 1h | Donn√©es sensibles |
| Stats documents | 4h | Change rarement |

## üöÄ Bonnes Pratiques

1. **Pr√©fixes de cl√©s** : Toujours utiliser des pr√©fixes clairs
2. **TTL appropri√©** : Adapter selon la fr√©quence de changement
3. **Invalidation** : Invalider imm√©diatement apr√®s modification
4. **Fallback** : Toujours avoir un fallback si cache indisponible
5. **Monitoring** : Surveiller le taux de cache hit/miss
6. **Pattern** : Utiliser `forgetPattern()` pour invalidations group√©es

## ‚ö†Ô∏è Attention

### Cache et Anonymat

Le cache des r√©sultats de vote **ne contient JAMAIS** :
- ‚ùå user_id
- ‚ùå token
- ‚ùå Lien vote ‚Üí utilisateur

Il contient **uniquement** les r√©sultats aggreg√©s :
- ‚úÖ Total votes
- ‚úÖ R√©sultats par choix
- ‚úÖ Pourcentages

### S√©curit√©

- Cache Redis doit √™tre **prot√©g√©** (firewall)
- Pas accessible de l'ext√©rieur
- Mot de passe Redis en production
- TTL pour auto-expiration

## üéØ Prochaines √âtapes

1. **Cache tags** : Grouper les cl√©s pour invalidation
2. **Cache warming** : Pr√©-chauffer les donn√©es critiques
3. **Cache aside** : Pattern pour haute disponibilit√©
4. **CDN** : Cacher les assets statiques
5. **Query cache** : Cacher les requ√™tes SQL

---

üíô CivicDash - Cache Redis pour Performance Optimale

