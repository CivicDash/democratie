# üåê Documentation Routes Web - CivicDash

## üìñ Vue d'ensemble

Les routes web de CivicDash utilisent **Inertia.js** pour cr√©er une Single Page Application (SPA) avec Laravel comme backend et Vue 3 comme frontend.

## üèóÔ∏è Architecture

```
Routes Web (routes/web.php)
    ‚Üì
Web Controllers (app/Http/Controllers/Web/)
    ‚Üì
Services (app/Services/)
    ‚Üì
Models + Policies
    ‚Üì
Inertia Response ‚Üí Vue Components
```

## üìÑ Structure des Fichiers

```
app/Http/Controllers/Web/
‚îú‚îÄ‚îÄ TopicController.php       # Forum citoyen
‚îú‚îÄ‚îÄ PostController.php         # R√©ponses aux topics
‚îú‚îÄ‚îÄ VoteController.php         # Vote anonyme
‚îú‚îÄ‚îÄ BudgetController.php       # Budget participatif
‚îú‚îÄ‚îÄ ModerationController.php   # Mod√©ration
‚îî‚îÄ‚îÄ DocumentController.php     # Documents publics

routes/
‚îú‚îÄ‚îÄ web.php                    # Routes Inertia
‚îî‚îÄ‚îÄ api.php                    # Routes API REST

app/Http/Middleware/
‚îî‚îÄ‚îÄ HandleInertiaRequests.php  # Props partag√©es globalement
```

## üåê Routes Compl√®tes

### üè† Page d'accueil

```php
GET /                          ‚Üí Welcome.vue
```

### üìù Forum Citoyen (Topics)

#### Routes Publiques
```php
GET /topics                    ‚Üí Topics/Index.vue
GET /topics/trending           ‚Üí Topics/Index.vue (trending)
GET /topics/{topic}            ‚Üí Topics/Show.vue
```

#### Routes Authentifi√©es
```php
GET  /topics/create            ‚Üí Topics/Create.vue
POST /topics                   ‚Üí Cr√©er un topic
GET  /topics/{topic}/edit      ‚Üí Topics/Edit.vue
PUT  /topics/{topic}           ‚Üí Mettre √† jour
DELETE /topics/{topic}         ‚Üí Supprimer

POST   /topics/{topic}/posts   ‚Üí Cr√©er une r√©ponse
PUT    /topics/posts/{post}    ‚Üí Modifier une r√©ponse
DELETE /topics/posts/{post}    ‚Üí Supprimer une r√©ponse
POST   /topics/posts/{post}/vote ‚Üí Voter (up/down)
```

**Permissions:**
- Cr√©er topic: `auth`
- Modifier/Supprimer: `owner` ou `admin`
- R√©pondre: `auth` + topic ouvert

### üó≥Ô∏è Vote Anonyme

#### Routes Publiques
```php
GET /vote/topics/{topic}           ‚Üí Vote/Show.vue
GET /vote/topics/{topic}/results   ‚Üí Vote/Results.vue
```

#### Routes Authentifi√©es
```php
POST /vote/topics/{topic}/token    ‚Üí Demander un jeton
POST /vote/topics/{topic}/cast     ‚Üí Voter (anonyme)
```

**Workflow:**
1. User demande un jeton cryptographique
2. User vote avec le jeton (anonyme)
3. R√©sultats affich√©s en temps r√©el

**Permissions:**
- Vote: `auth` + `citizen` + pas d√©j√† vot√©

### üí∞ Budget Participatif

#### Routes Publiques
```php
GET /budget                ‚Üí Budget/Index.vue
GET /budget/stats          ‚Üí Budget/Stats.vue
GET /budget/sectors        ‚Üí Budget/Sectors.vue
```

#### Routes Authentifi√©es
```php
GET    /budget/my-allocations  ‚Üí Mes allocations (JSON)
POST   /budget/allocate        ‚Üí Allouer (1 secteur)
POST   /budget/bulk-allocate   ‚Üí Allouer en masse
DELETE /budget/reset           ‚Üí R√©initialiser
```

**Permissions:**
- Allouer: `auth` + `citizen`

### üö® Mod√©ration

**Toutes les routes n√©cessitent:** `auth` + `role:moderator|admin`

```php
GET /moderation/dashboard                     ‚Üí Moderation/Dashboard.vue
GET /moderation/reports                       ‚Üí Moderation/Reports.vue
GET /moderation/reports/priority              ‚Üí Moderation/PriorityReports.vue
GET /moderation/reports/{report}              ‚Üí Moderation/ReportDetail.vue

POST   /moderation/reports/{report}/assign    ‚Üí Assigner un signalement
POST   /moderation/reports/{report}/resolve   ‚Üí R√©soudre
POST   /moderation/reports/{report}/reject    ‚Üí Rejeter

GET    /moderation/sanctions                  ‚Üí Moderation/Sanctions.vue
GET    /moderation/sanctions/{sanction}       ‚Üí Moderation/SanctionDetail.vue
DELETE /moderation/sanctions/{sanction}       ‚Üí R√©voquer

GET /moderation/stats                         ‚Üí Moderation/Stats.vue
```

**Route publique de signalement:**
```php
POST /reports    ‚Üí Cr√©er un signalement (auth requis)
```

### üìÑ Documents Publics

#### Routes Publiques
```php
GET /documents                    ‚Üí Documents/Index.vue
GET /documents/{document}         ‚Üí Documents/Show.vue
GET /documents/{document}/download ‚Üí T√©l√©charger PDF
GET /documents/stats              ‚Üí Documents/Stats.vue
```

#### Routes Authentifi√©es
```php
POST   /documents              ‚Üí Upload document
PUT    /documents/{document}   ‚Üí Mettre √† jour
DELETE /documents/{document}   ‚Üí Supprimer
```

#### Routes V√©rificateurs (`journalist|ong|admin`)
```php
GET  /documents/pending               ‚Üí Documents/Pending.vue
POST /documents/{document}/verify     ‚Üí V√©rifier un document
```

### üë§ Profil & Dashboard

```php
GET    /dashboard             ‚Üí Dashboard.vue (auth + verified)
GET    /profile               ‚Üí Profile/Edit.vue
PATCH  /profile               ‚Üí Mettre √† jour profil
DELETE /profile               ‚Üí Supprimer compte
```

### üëë Administration

**N√©cessite:** `auth` + `role:admin`

```php
GET /admin/dashboard          ‚Üí Admin/Dashboard.vue
```

### üîê Authentification

Routes fournies par Laravel Breeze :
```php
GET  /login                   ‚Üí Auth/Login.vue
POST /login                   ‚Üí Authentifier
POST /logout                  ‚Üí D√©connecter

GET  /register                ‚Üí Auth/Register.vue
POST /register                ‚Üí Cr√©er compte

GET  /forgot-password         ‚Üí Auth/ForgotPassword.vue
POST /forgot-password         ‚Üí Envoyer email reset

GET  /reset-password/{token}  ‚Üí Auth/ResetPassword.vue
POST /reset-password          ‚Üí R√©initialiser

GET  /verify-email            ‚Üí Auth/VerifyEmail.vue
POST /email/verification-notification ‚Üí Renvoyer email

GET  /confirm-password        ‚Üí Auth/ConfirmPassword.vue
POST /confirm-password        ‚Üí Confirmer
```

## üõ†Ô∏è Web Controllers

### TopicController

**M√©thodes:**
- `index()` - Liste avec filtres (search, scope, type)
- `trending()` - Topics populaires
- `show()` - D√©tails + posts
- `create()` - Formulaire cr√©ation
- `store()` - Cr√©er
- `edit()` - Formulaire √©dition
- `update()` - Mettre √† jour
- `destroy()` - Supprimer

**Services utilis√©s:** `TopicService`

### PostController

**M√©thodes:**
- `store()` - Cr√©er r√©ponse
- `update()` - Modifier
- `destroy()` - Supprimer
- `vote()` - Voter (up/down)

**Services utilis√©s:** `TopicService`

### VoteController

**M√©thodes:**
- `show()` - Page de vote (3 √©tapes)
- `results()` - R√©sultats
- `requestToken()` - Jeton cryptographique
- `cast()` - Voter anonymement

**Services utilis√©s:** `BallotService`

### BudgetController

**M√©thodes:**
- `index()` - Page allocation
- `stats()` - Statistiques
- `sectors()` - Liste secteurs
- `myAllocations()` - Mes allocations (JSON)
- `allocate()` - Allouer (1 secteur)
- `bulkAllocate()` - Allouer en masse
- `reset()` - R√©initialiser

**Services utilis√©s:** `BudgetService`

### ModerationController

**M√©thodes:**
- `dashboard()` - Dashboard
- `reports()` - Liste signalements
- `priorityReports()` - Prioritaires
- `showReport()` - D√©tails signalement
- `store()` - Cr√©er signalement
- `assignReport()` - Assigner
- `resolveReport()` - R√©soudre
- `rejectReport()` - Rejeter
- `sanctions()` - Liste sanctions
- `showSanction()` - D√©tails sanction
- `revokeSanction()` - R√©voquer
- `stats()` - Statistiques

**Services utilis√©s:** `ModerationService`

### DocumentController

**M√©thodes:**
- `index()` - Liste documents
- `show()` - D√©tails
- `store()` - Upload
- `update()` - Mettre √† jour
- `destroy()` - Supprimer
- `download()` - T√©l√©charger PDF
- `pending()` - En attente v√©rification
- `verify()` - V√©rifier
- `stats()` - Statistiques

**Services utilis√©s:** `DocumentService`

## üîß Middleware Inertia

### HandleInertiaRequests

Partage automatiquement des props globales :

```php
public function share(Request $request): array
{
    return [
        'auth' => [
            'user' => [
                'id' => ...,
                'name' => ...,
                'email' => ...,
                'roles' => [...],
                'permissions' => [...],
            ],
        ],
        'flash' => [
            'success' => ...,
            'error' => ...,
            'warning' => ...,
            'info' => ...,
        ],
    ];
}
```

**Acc√®s dans Vue:**
```vue
<script setup>
const user = $page.props.auth.user;
const flash = $page.props.flash;
</script>
```

## üé® Conventions de R√©ponse

### Succ√®s
```php
return back()->with('success', 'Action r√©ussie !');
return redirect()->route('topics.show', $topic)
    ->with('success', 'Topic cr√©√© !');
```

### Erreurs
```php
return back()->with('error', 'Une erreur est survenue.');
abort(403, 'Non autoris√©');
abort(404, 'Ressource introuvable');
```

### JSON (API-like)
```php
return response()->json($data);
return response()->json($data, 201); // Created
```

## üîê Autorisation

### Policy-based
```php
$this->authorize('update', $topic);
$this->authorize('create', Topic::class);
```

### Gate-based
```php
Gate::authorize('access-moderation-dashboard');
```

### Middleware
```php
Route::middleware('role:moderator|admin')->group(...);
Route::middleware(['auth', 'verified'])->group(...);
```

## üìä Pagination

Toutes les listes utilisent la pagination Laravel :

```php
$topics = Topic::latest()->paginate(15);

return Inertia::render('Topics/Index', [
    'topics' => $topics, // Inclut automatiquement links, meta, etc.
]);
```

**Dans Vue:**
```vue
<Pagination :links="topics.links" />
```

## üîç Filtres & Recherche

Pattern recommand√© :

```php
public function index(Request $request)
{
    $query = Model::query();
    
    if ($request->filled('search')) {
        $query->where('title', 'like', "%{$request->search}%");
    }
    
    if ($request->filled('status')) {
        $query->where('status', $request->status);
    }
    
    $items = $query->paginate(15)->withQueryString();
    
    return Inertia::render('Page', [
        'items' => $items,
        'filters' => $request->only(['search', 'status']),
    ]);
}
```

## üöÄ Performance

### Eager Loading
```php
$topic->load(['author', 'region', 'department']);
$topic->loadCount('ballots');
```

### Lazy Eager Loading
```php
$topics = Topic::with(['author', 'region'])->paginate();
```

### Select Specific Columns
```php
$topics = Topic::select(['id', 'title', 'created_at'])->get();
```

## üß™ Tester les Routes

```bash
# Lancer le serveur
php artisan serve

# Avec Vite (hot reload)
npm run dev

# Acc√©der
http://localhost:8000/topics
http://localhost:8000/budget
http://localhost:8000/documents
```

## üìù Exemples d'Utilisation

### Cr√©er un Topic
```
1. User: GET /topics/create
2. Vue: Affiche formulaire (Topics/Create.vue)
3. User: Remplit et submit
4. POST /topics ‚Üí TopicController@store
5. TopicService ‚Üí createTopic()
6. Redirect: /topics/{topic} avec message success
```

### Voter Anonymement
```
1. User: GET /vote/topics/1
2. Vue: Affiche page Vote/Show.vue (√©tape 1)
3. User: Click "Obtenir jeton"
4. POST /vote/topics/1/token ‚Üí VoteController@requestToken
5. BallotService ‚Üí requestBallotToken()
6. Retour avec flash token
7. Vue: Affiche √©tape 2 (formulaire vote)
8. User: S√©lectionne choix et submit
9. POST /vote/topics/1/cast ‚Üí VoteController@cast
10. BallotService ‚Üí castVote() (anonyme)
11. Vue: Affiche √©tape 3 (r√©sultats)
```

### Allouer Budget
```
1. User: GET /budget
2. Vue: Affiche Budget/Index.vue avec sliders
3. User: Ajuste allocations (100%)
4. User: Submit
5. POST /budget/bulk-allocate ‚Üí BudgetController@bulkAllocate
6. BudgetService ‚Üí bulkAllocate()
7. Retour avec message success
8. Vue: Rafra√Æchit avec nouvelles donn√©es
```

## üéØ Prochaines √âtapes

1. **API Resources** : Formater proprement les r√©ponses JSON
2. **Rate Limiting** : Limiter les requ√™tes par user
3. **Cache** : Mettre en cache les stats et r√©sultats
4. **Validation Frontend** : Validation en temps r√©el
5. **Tests E2E** : Cypress ou Playwright

## ü§ù Contribution

Voir `CONTRIBUTING.md` pour les guidelines.

---

üíô CivicDash - D√©mocratie Participative Open Source

