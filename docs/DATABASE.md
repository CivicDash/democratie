# Sch√©ma de base de donn√©es - CivicDash

## üìã Vue d'ensemble

Le sch√©ma de base de donn√©es CivicDash est organis√© en 6 domaines fonctionnels :

1. **Identit√© & Territoires** (3 tables)
2. **Forum & Discussions** (3 tables)
3. **Mod√©ration** (2 tables)
4. **Vote Anonyme** (2 tables) ‚ö†Ô∏è Architecture sp√©ciale
5. **Budget Participatif** (4 tables)
6. **Documents V√©rifi√©s** (2 tables)

**Total : 16 tables m√©tier** + 3 tables Laravel (users, cache, jobs)

---

## üóÇÔ∏è Domaine 1 : Identit√© & Territoires

### `territories_regions`
R√©gions fran√ßaises (INSEE).

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| code | string(2) | Code INSEE (ex: 11, 93) |
| name | string | Nom (ex: √éle-de-France) |

### `territories_departments`
D√©partements fran√ßais (INSEE).

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| code | string(3) | Code INSEE (ex: 75, 2A) |
| name | string | Nom (ex: Paris) |
| region_id | bigint | FK ‚Üí regions |

### `profiles`
Profils citoyens avec pseudonymes et scope territorial.

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| user_id | bigint | FK ‚Üí users |
| display_name | string | Pseudonyme al√©atoire (Citoyen123) |
| citizen_ref_hash | string | **Hash num√©ro s√©cu + PEPPER** |
| scope | enum | national / region / dept |
| region_id | bigint | FK ‚Üí regions (nullable) |
| department_id | bigint | FK ‚Üí departments (nullable) |
| is_verified | boolean | Identit√© v√©rifi√©e (FranceConnect+) |
| verified_at | timestamp | Date v√©rification |

**üîê S√©curit√©** : `citizen_ref_hash` est unique et permet d'√©viter les doublons sans stocker le num√©ro de s√©cu en clair.

---

## üí¨ Domaine 2 : Forum & Discussions

### `topics`
Sujets de d√©bat, projets de loi, r√©f√©rendums.

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| title | string | Titre |
| description | text | Markdown restreint |
| scope | enum | national / region / dept |
| region_id | bigint | FK ‚Üí regions (nullable) |
| department_id | bigint | FK ‚Üí departments (nullable) |
| type | enum | debate / bill / referendum |
| status | enum | draft / open / closed / archived |
| author_id | bigint | FK ‚Üí users (legislator/admin) |
| **has_ballot** | boolean | Active le scrutin |
| **voting_opens_at** | timestamp | Ouverture scrutin |
| **voting_deadline_at** | timestamp | Fermeture + r√©v√©lation |
| **ballot_type** | enum | yes_no / multiple_choice / preferential |
| **ballot_options** | json | Options (si multiple_choice) |

### `posts`
Messages de d√©bat (avec threading).

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| topic_id | bigint | FK ‚Üí topics |
| user_id | bigint | FK ‚Üí users |
| parent_id | bigint | FK ‚Üí posts (nullable, threading) |
| content | text | Markdown restreint |
| is_official | boolean | Post officiel (legislator/state) |
| upvotes | int | Compteur votes positifs |
| downvotes | int | Compteur votes n√©gatifs |
| is_pinned | boolean | √âpingl√© |
| is_hidden | boolean | Masqu√© par mod√©ration |
| hidden_reason | string | Raison masquage |

### `post_votes`
Votes up/down sur posts.

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| post_id | bigint | FK ‚Üí posts |
| user_id | bigint | FK ‚Üí users |
| vote | enum | up / down |

**Contrainte** : `UNIQUE(post_id, user_id)` ‚Üí 1 vote par user par post.

---

## üõ°Ô∏è Domaine 3 : Mod√©ration

### `reports`
Signalements de contenus.

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| reporter_id | bigint | FK ‚Üí users |
| reportable_type | string | posts / topics / ... (polymorphic) |
| reportable_id | bigint | ID du contenu |
| reason | enum | spam / harassment / misinformation / ... |
| description | text | D√©tails |
| status | enum | pending / reviewing / resolved / dismissed |
| moderator_id | bigint | FK ‚Üí users (nullable) |
| moderator_notes | text | Notes mod√©rateur |
| resolved_at | timestamp | Date r√©solution |

### `sanctions`
Sanctions (avertissements, mutes, bans).

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| user_id | bigint | FK ‚Üí users (sanctionn√©) |
| moderator_id | bigint | FK ‚Üí users (mod√©rateur) |
| report_id | bigint | FK ‚Üí reports (nullable) |
| type | enum | warning / mute / ban |
| reason | text | Motif |
| starts_at | timestamp | D√©but |
| expires_at | timestamp | Fin (NULL = permanent) |
| is_active | boolean | Active |

---

## üó≥Ô∏è Domaine 4 : Vote Anonyme ‚ö†Ô∏è

### `ballot_tokens`
Jetons √©ph√©m√®res pour voter (liaison identit√© ‚Üî vote).

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| topic_id | bigint | FK ‚Üí topics |
| user_id | bigint | FK ‚Üí users |
| token | string(128) | **Jeton opaque sign√© √† usage unique** |
| consumed | boolean | Jeton consomm√© |
| consumed_at | timestamp | Date consommation |
| expires_at | timestamp | Expiration (= voting_deadline_at) |

**Contrainte** : `UNIQUE(topic_id, user_id)` ‚Üí 1 jeton par user par scrutin.

### `topic_ballots`
Bulletins de vote anonymes **SANS user_id**.

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| topic_id | bigint | FK ‚Üí topics |
| **‚ö†Ô∏è PAS de user_id** | | **Anonymat garanti** |
| encrypted_vote | string | **Vote chiffr√© (Laravel Crypt)** |
| vote_hash | string(64) | Hash du vote (unicit√©) |
| cast_at | timestamp | Date du vote |

**üîê Architecture anonyme** :
1. User obtient un `ballot_token`
2. User vote avec le token (API)
3. Token consomm√©, `topic_ballot` cr√©√© **sans user_id**
4. Liaison identit√©/vote **supprim√©e**
5. R√©sultats r√©v√©l√©s uniquement apr√®s `voting_deadline_at`

**Contrainte** : `UNIQUE(vote_hash)` ‚Üí √©vite les votes dupliqu√©s.

---

## üí∞ Domaine 5 : Budget Participatif

### `sectors`
Secteurs budg√©taires (√©ducation, sant√©, etc.).

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| code | string(50) | Code unique (EDU, HEALTH) |
| name | string | Nom (√âducation, Sant√©) |
| description | text | Description |
| icon | string(50) | Nom ic√¥ne (graduation-cap) |
| color | string(7) | Couleur hex (#0055a4) |
| min_percent | decimal(5,2) | % minimum allouable |
| max_percent | decimal(5,2) | % maximum allouable |
| display_order | int | Ordre affichage |
| is_active | boolean | Actif |

### `user_allocations`
R√©partitions budg√©taires des citoyens.

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| user_id | bigint | FK ‚Üí users |
| sector_id | bigint | FK ‚Üí sectors |
| percent | decimal(5,2) | % allou√© |

**Contraintes** :
- `UNIQUE(user_id, sector_id)` ‚Üí 1 allocation par user par secteur
- Somme des `percent` par user = 100%
- `percent` entre `min_percent` et `max_percent` du secteur

### `public_revenue`
Recettes publiques (transparence).

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| year | int | Ann√©e fiscale |
| scope | enum | national / region / dept |
| region_id | bigint | FK ‚Üí regions (nullable) |
| department_id | bigint | FK ‚Üí departments (nullable) |
| category | string(100) | Cat√©gorie (TVA, IRPP) |
| amount | decimal(15,2) | Montant (‚Ç¨) |
| source | string(255) | Source donn√©es (INSEE, DGFiP) |

### `public_spend`
D√©penses publiques par secteur.

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| year | int | Ann√©e fiscale |
| scope | enum | national / region / dept |
| region_id | bigint | FK ‚Üí regions (nullable) |
| department_id | bigint | FK ‚Üí departments (nullable) |
| sector_id | bigint | FK ‚Üí sectors |
| amount | decimal(15,2) | Montant d√©pens√© (‚Ç¨) |
| program | string(255) | Programme sp√©cifique |
| source | string(255) | Source donn√©es |

---

## üìÑ Domaine 6 : Documents V√©rifi√©s

### `documents`
Pi√®ces jointes (uploadables par legislator/state).

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| title | string | Titre |
| description | text | Description |
| filename | string | Nom fichier |
| path | string | Chemin stockage |
| mime_type | string(100) | Type MIME |
| size | bigint | Taille (bytes) |
| hash | string(64) | SHA256 du fichier |
| documentable_type | string | topics / posts / ... (polymorphic) |
| documentable_id | bigint | ID du contenu |
| uploader_id | bigint | FK ‚Üí users (legislator/state) |
| status | enum | pending / verified / rejected |
| is_public | boolean | Public |

### `verifications`
V√©rifications par journalistes/ONG.

| Colonne | Type | Description |
|---------|------|-------------|
| id | bigint | PK |
| document_id | bigint | FK ‚Üí documents |
| verifier_id | bigint | FK ‚Üí users (journalist/ong) |
| status | enum | verified / rejected / needs_review |
| notes | text | Commentaires |
| metadata | json | Donn√©es suppl√©mentaires |

---

## üîó Relations cl√©s

### S√©paration identit√©/vote
```
users ‚Üí ballot_tokens ‚Üí [TOKEN] ‚Üí topic_ballots (PAS de user_id)
        ‚Üì consumed=true
```

### Forum hi√©rarchique
```
topics
  ‚îú‚îÄ posts (parent_id = NULL)
  ‚îÇ   ‚îî‚îÄ posts (parent_id ‚Üí post parent)
  ‚îî‚îÄ post_votes
```

### Mod√©ration
```
posts/topics ‚Üí reports ‚Üí sanctions ‚Üí users
```

### Budget
```
users ‚Üí user_allocations ‚Üí sectors
sectors ‚Üí public_spend (comparaison)
```

---

## üìä Indexes importants

- **profiles** : `citizen_ref_hash` (unique), `[scope, region_id, department_id]`
- **topics** : `[scope, status]`, `voting_deadline_at`
- **posts** : `[topic_id, created_at]`
- **ballot_tokens** : `token` (unique), `[topic_id, consumed]`
- **topic_ballots** : `topic_id`, `vote_hash` (unique)
- **user_allocations** : `[user_id, sector_id]` (unique)

---

## üöÄ Prochaines √©tapes

1. ‚úÖ Migrations cr√©√©es
2. üîÑ Cr√©er les mod√®les Eloquent
3. üîÑ Cr√©er les seeders (r√¥les, territoires, secteurs)
4. üîÑ Cr√©er les factories pour tests
5. üîÑ Impl√©menter les services m√©tier (BallotService, BudgetService)

---

**Note** : Ce sch√©ma respecte strictement les principes CivicDash :
- ‚úÖ Anonymat des votes garanti (pas de user_id dans topic_ballots)
- ‚úÖ Pas d'images/liens citoyens (validation serveur)
- ‚úÖ Scope territorial (national/region/dept)
- ‚úÖ Mod√©ration workflow complet
- ‚úÖ Transparence budg√©taire

